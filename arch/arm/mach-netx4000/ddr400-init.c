#include <common.h>
#include <mach/netx4000_regs.h>
#include <mach/netx4000_ddr.h>

#include CONFIG_DDR400_RAM_INCLUDE

#define DDRCTRL_DENALI_CTL(n)   (*(volatile uint32_t*)(Adr_NX4000_DDR_CTRL_CTL_00 + (n * 4)))
#define PHYCTRL_CTL(n)   (*(volatile uint32_t*)(Adr_NX4000_DDR_PHY_DDR_PHY_FUNCCTRL + (n * 4)))

int ddr400_init(void) {
	volatile uint32_t *RAP_SYSCTRL_NOCPWRCTRL = (volatile uint32_t *)0xf8000040;
	volatile uint32_t *RAP_SYSCTRL_NOCPWRSTAT = (volatile uint32_t *)0xf8000048;
	volatile uint32_t *RAP_SYSCTRL_CLKCFG = (volatile uint32_t *)0xf800004c;
	int ecc;

	// Enable DDR clock.
	while (!(*RAP_SYSCTRL_NOCPWRSTAT & 0x40)) {
		*RAP_SYSCTRL_CLKCFG |= 0x40;
		*RAP_SYSCTRL_NOCPWRCTRL |= 0x40;
	}
	
	/* Only perform initialization if not done from a previous run / rom loader */
	if(0 != (DDRCTRL_DENALI_CTL(0) & 0x1)) {
		return (DDRCTRL_DENALI_CTL(152) & 1) ? 1 : 0;
	}

	DDRCTRL_DENALI_CTL(0) = DENALI_CTL_00_DATA;
	DDRCTRL_DENALI_CTL(1) = DENALI_CTL_01_DATA;
	DDRCTRL_DENALI_CTL(2) = DENALI_CTL_02_DATA;
	DDRCTRL_DENALI_CTL(3) = DENALI_CTL_03_DATA;
	DDRCTRL_DENALI_CTL(4) = DENALI_CTL_04_DATA;
	DDRCTRL_DENALI_CTL(5) = DENALI_CTL_05_DATA;
	DDRCTRL_DENALI_CTL(6) = DENALI_CTL_06_DATA;
	DDRCTRL_DENALI_CTL(7) = DENALI_CTL_07_DATA;
	DDRCTRL_DENALI_CTL(8) = DENALI_CTL_08_DATA;
	DDRCTRL_DENALI_CTL(9) = DENALI_CTL_09_DATA;
	DDRCTRL_DENALI_CTL(10) = DENALI_CTL_10_DATA;
	DDRCTRL_DENALI_CTL(11) = DENALI_CTL_11_DATA;
	DDRCTRL_DENALI_CTL(12) = DENALI_CTL_12_DATA;
	DDRCTRL_DENALI_CTL(13) = DENALI_CTL_13_DATA;
	DDRCTRL_DENALI_CTL(14) = DENALI_CTL_14_DATA;
	DDRCTRL_DENALI_CTL(15) = DENALI_CTL_15_DATA;
	DDRCTRL_DENALI_CTL(16) = DENALI_CTL_16_DATA;
	DDRCTRL_DENALI_CTL(17) = DENALI_CTL_17_DATA;
	DDRCTRL_DENALI_CTL(18) = DENALI_CTL_18_DATA;
	DDRCTRL_DENALI_CTL(19) = DENALI_CTL_19_DATA;
	DDRCTRL_DENALI_CTL(20) = DENALI_CTL_20_DATA;
	DDRCTRL_DENALI_CTL(21) = DENALI_CTL_21_DATA;
	DDRCTRL_DENALI_CTL(22) = DENALI_CTL_22_DATA;
	DDRCTRL_DENALI_CTL(23) = DENALI_CTL_23_DATA;
	DDRCTRL_DENALI_CTL(24) = DENALI_CTL_24_DATA;
	DDRCTRL_DENALI_CTL(25) = DENALI_CTL_25_DATA;
	DDRCTRL_DENALI_CTL(26) = DENALI_CTL_26_DATA;
	DDRCTRL_DENALI_CTL(27) = DENALI_CTL_27_DATA;
	DDRCTRL_DENALI_CTL(28) = DENALI_CTL_28_DATA;
	DDRCTRL_DENALI_CTL(29) = DENALI_CTL_29_DATA;
	DDRCTRL_DENALI_CTL(30) = DENALI_CTL_30_DATA;
	DDRCTRL_DENALI_CTL(31) = DENALI_CTL_31_DATA;
	DDRCTRL_DENALI_CTL(32) = DENALI_CTL_32_DATA;
	DDRCTRL_DENALI_CTL(33) = DENALI_CTL_33_DATA;
	DDRCTRL_DENALI_CTL(34) = DENALI_CTL_34_DATA;
	DDRCTRL_DENALI_CTL(35) = DENALI_CTL_35_DATA;
	DDRCTRL_DENALI_CTL(36) = DENALI_CTL_36_DATA;
	DDRCTRL_DENALI_CTL(37) = DENALI_CTL_37_DATA;
	DDRCTRL_DENALI_CTL(38) = DENALI_CTL_38_DATA;
	DDRCTRL_DENALI_CTL(39) = DENALI_CTL_39_DATA;
	DDRCTRL_DENALI_CTL(40) = DENALI_CTL_40_DATA;
	DDRCTRL_DENALI_CTL(41) = DENALI_CTL_41_DATA;
	DDRCTRL_DENALI_CTL(42) = DENALI_CTL_42_DATA;
	DDRCTRL_DENALI_CTL(43) = DENALI_CTL_43_DATA;
	DDRCTRL_DENALI_CTL(44) = DENALI_CTL_44_DATA;
	DDRCTRL_DENALI_CTL(45) = DENALI_CTL_45_DATA;
	DDRCTRL_DENALI_CTL(46) = DENALI_CTL_46_DATA;
	DDRCTRL_DENALI_CTL(47) = DENALI_CTL_47_DATA;
	DDRCTRL_DENALI_CTL(48) = DENALI_CTL_48_DATA;
	DDRCTRL_DENALI_CTL(49) = DENALI_CTL_49_DATA;
	DDRCTRL_DENALI_CTL(50) = DENALI_CTL_50_DATA;
	DDRCTRL_DENALI_CTL(51) = DENALI_CTL_51_DATA;
	DDRCTRL_DENALI_CTL(52) = DENALI_CTL_52_DATA;
	DDRCTRL_DENALI_CTL(53) = DENALI_CTL_53_DATA;
	DDRCTRL_DENALI_CTL(54) = DENALI_CTL_54_DATA;
	DDRCTRL_DENALI_CTL(55) = DENALI_CTL_55_DATA;
	DDRCTRL_DENALI_CTL(56) = DENALI_CTL_56_DATA;
	DDRCTRL_DENALI_CTL(57) = DENALI_CTL_57_DATA;
	DDRCTRL_DENALI_CTL(58) = DENALI_CTL_58_DATA;
	DDRCTRL_DENALI_CTL(59) = DENALI_CTL_59_DATA;
	DDRCTRL_DENALI_CTL(60) = DENALI_CTL_60_DATA;
	DDRCTRL_DENALI_CTL(61) = DENALI_CTL_61_DATA;
	DDRCTRL_DENALI_CTL(62) = DENALI_CTL_62_DATA;
	DDRCTRL_DENALI_CTL(63) = DENALI_CTL_63_DATA;
	DDRCTRL_DENALI_CTL(64) = DENALI_CTL_64_DATA;
	DDRCTRL_DENALI_CTL(65) = DENALI_CTL_65_DATA;
	DDRCTRL_DENALI_CTL(66) = DENALI_CTL_66_DATA;
	DDRCTRL_DENALI_CTL(67) = DENALI_CTL_67_DATA;
	DDRCTRL_DENALI_CTL(68) = DENALI_CTL_68_DATA;
	DDRCTRL_DENALI_CTL(69) = DENALI_CTL_69_DATA;
	DDRCTRL_DENALI_CTL(70) = DENALI_CTL_70_DATA;
	DDRCTRL_DENALI_CTL(71) = DENALI_CTL_71_DATA;
	DDRCTRL_DENALI_CTL(72) = DENALI_CTL_72_DATA;
	DDRCTRL_DENALI_CTL(73) = DENALI_CTL_73_DATA;
	DDRCTRL_DENALI_CTL(74) = DENALI_CTL_74_DATA;
	DDRCTRL_DENALI_CTL(75) = DENALI_CTL_75_DATA;
	DDRCTRL_DENALI_CTL(76) = DENALI_CTL_76_DATA;
	DDRCTRL_DENALI_CTL(77) = DENALI_CTL_77_DATA;
	DDRCTRL_DENALI_CTL(78) = DENALI_CTL_78_DATA;
	DDRCTRL_DENALI_CTL(79) = DENALI_CTL_79_DATA;
	DDRCTRL_DENALI_CTL(80) = DENALI_CTL_80_DATA;
	DDRCTRL_DENALI_CTL(81) = DENALI_CTL_81_DATA;
	DDRCTRL_DENALI_CTL(82) = DENALI_CTL_82_DATA;
	DDRCTRL_DENALI_CTL(83) = DENALI_CTL_83_DATA;
	DDRCTRL_DENALI_CTL(84) = DENALI_CTL_84_DATA;
	DDRCTRL_DENALI_CTL(85) = DENALI_CTL_85_DATA;
	DDRCTRL_DENALI_CTL(86) = DENALI_CTL_86_DATA;
	DDRCTRL_DENALI_CTL(87) = DENALI_CTL_87_DATA;
	DDRCTRL_DENALI_CTL(88) = DENALI_CTL_88_DATA;
	DDRCTRL_DENALI_CTL(89) = DENALI_CTL_89_DATA;
	DDRCTRL_DENALI_CTL(90) = DENALI_CTL_90_DATA;
	DDRCTRL_DENALI_CTL(91) = DENALI_CTL_91_DATA;
	DDRCTRL_DENALI_CTL(92) = DENALI_CTL_92_DATA;
	DDRCTRL_DENALI_CTL(93) = DENALI_CTL_93_DATA;
	DDRCTRL_DENALI_CTL(94) = DENALI_CTL_94_DATA;
	DDRCTRL_DENALI_CTL(95) = DENALI_CTL_95_DATA;
	DDRCTRL_DENALI_CTL(96) = DENALI_CTL_96_DATA;
	DDRCTRL_DENALI_CTL(97) = DENALI_CTL_97_DATA;
	DDRCTRL_DENALI_CTL(98) = DENALI_CTL_98_DATA;
	DDRCTRL_DENALI_CTL(99) = DENALI_CTL_99_DATA;
	DDRCTRL_DENALI_CTL(100) = DENALI_CTL_100_DATA;
	DDRCTRL_DENALI_CTL(101) = DENALI_CTL_101_DATA;
	DDRCTRL_DENALI_CTL(102) = DENALI_CTL_102_DATA;
	DDRCTRL_DENALI_CTL(103) = DENALI_CTL_103_DATA;
	DDRCTRL_DENALI_CTL(104) = DENALI_CTL_104_DATA;
	DDRCTRL_DENALI_CTL(105) = DENALI_CTL_105_DATA;
	DDRCTRL_DENALI_CTL(106) = DENALI_CTL_106_DATA;
	DDRCTRL_DENALI_CTL(107) = DENALI_CTL_107_DATA;
	DDRCTRL_DENALI_CTL(108) = DENALI_CTL_108_DATA;
	DDRCTRL_DENALI_CTL(109) = DENALI_CTL_109_DATA;
	DDRCTRL_DENALI_CTL(110) = DENALI_CTL_110_DATA;
	DDRCTRL_DENALI_CTL(111) = DENALI_CTL_111_DATA;
	DDRCTRL_DENALI_CTL(112) = DENALI_CTL_112_DATA;
	DDRCTRL_DENALI_CTL(113) = DENALI_CTL_113_DATA;
	DDRCTRL_DENALI_CTL(114) = DENALI_CTL_114_DATA;
	DDRCTRL_DENALI_CTL(115) = DENALI_CTL_115_DATA;
	DDRCTRL_DENALI_CTL(116) = DENALI_CTL_116_DATA;
	DDRCTRL_DENALI_CTL(117) = DENALI_CTL_117_DATA;
	DDRCTRL_DENALI_CTL(118) = DENALI_CTL_118_DATA;
	DDRCTRL_DENALI_CTL(119) = DENALI_CTL_119_DATA;
	DDRCTRL_DENALI_CTL(120) = DENALI_CTL_120_DATA;
	DDRCTRL_DENALI_CTL(121) = DENALI_CTL_121_DATA;
	DDRCTRL_DENALI_CTL(122) = DENALI_CTL_122_DATA;
	DDRCTRL_DENALI_CTL(123) = DENALI_CTL_123_DATA;
	DDRCTRL_DENALI_CTL(124) = DENALI_CTL_124_DATA;
	DDRCTRL_DENALI_CTL(125) = DENALI_CTL_125_DATA;
	DDRCTRL_DENALI_CTL(126) = DENALI_CTL_126_DATA;
	DDRCTRL_DENALI_CTL(127) = DENALI_CTL_127_DATA;
	DDRCTRL_DENALI_CTL(128) = DENALI_CTL_128_DATA;
	DDRCTRL_DENALI_CTL(129) = DENALI_CTL_129_DATA;
	DDRCTRL_DENALI_CTL(130) = DENALI_CTL_130_DATA;
	DDRCTRL_DENALI_CTL(131) = DENALI_CTL_131_DATA;
	DDRCTRL_DENALI_CTL(132) = DENALI_CTL_132_DATA;
	DDRCTRL_DENALI_CTL(133) = DENALI_CTL_133_DATA;
	DDRCTRL_DENALI_CTL(134) = DENALI_CTL_134_DATA;
	DDRCTRL_DENALI_CTL(135) = DENALI_CTL_135_DATA;
	DDRCTRL_DENALI_CTL(136) = DENALI_CTL_136_DATA;
	DDRCTRL_DENALI_CTL(137) = DENALI_CTL_137_DATA;
	DDRCTRL_DENALI_CTL(138) = DENALI_CTL_138_DATA;
	DDRCTRL_DENALI_CTL(139) = DENALI_CTL_139_DATA;
	DDRCTRL_DENALI_CTL(140) = DENALI_CTL_140_DATA;
	DDRCTRL_DENALI_CTL(141) = DENALI_CTL_141_DATA;
	DDRCTRL_DENALI_CTL(142) = DENALI_CTL_142_DATA;
	DDRCTRL_DENALI_CTL(143) = DENALI_CTL_143_DATA;
	DDRCTRL_DENALI_CTL(144) = DENALI_CTL_144_DATA;
	DDRCTRL_DENALI_CTL(145) = DENALI_CTL_145_DATA;
	DDRCTRL_DENALI_CTL(146) = DENALI_CTL_146_DATA;
	DDRCTRL_DENALI_CTL(147) = DENALI_CTL_147_DATA;
	DDRCTRL_DENALI_CTL(148) = DENALI_CTL_148_DATA;
	DDRCTRL_DENALI_CTL(149) = DENALI_CTL_149_DATA;
	DDRCTRL_DENALI_CTL(150) = DENALI_CTL_150_DATA;
	DDRCTRL_DENALI_CTL(151) = DENALI_CTL_151_DATA;

#ifdef CONFIG_ENABLE_DDR_ECC
	DDRCTRL_DENALI_CTL(152) = DENALI_CTL_152_DATA | 0x1;
	ecc = 1;
#else
	DDRCTRL_DENALI_CTL(152) = DENALI_CTL_152_DATA & ~0x1;
	ecc = 0;
#endif

	DDRCTRL_DENALI_CTL(153) = DENALI_CTL_153_DATA;

#ifdef DENALI_CTL_154_DATA
	DDRCTRL_DENALI_CTL(154) = DENALI_CTL_154_DATA;
	DDRCTRL_DENALI_CTL(155) = DENALI_CTL_155_DATA;
	DDRCTRL_DENALI_CTL(156) = DENALI_CTL_156_DATA;
	DDRCTRL_DENALI_CTL(157) = DENALI_CTL_157_DATA;
	DDRCTRL_DENALI_CTL(158) = DENALI_CTL_158_DATA;
	DDRCTRL_DENALI_CTL(169) = DENALI_CTL_159_DATA;
	DDRCTRL_DENALI_CTL(160) = DENALI_CTL_160_DATA;
	DDRCTRL_DENALI_CTL(161) = DENALI_CTL_161_DATA;
	DDRCTRL_DENALI_CTL(162) = DENALI_CTL_162_DATA;
#endif

	PHYCTRL_CTL(0) = (0x1 << SRT_NX4000_DDR_PHY_FUNCCTRL_IFSEL) | MSK_NX4000_DDR_PHY_FUNCCTRL_FUNCRSTB;
	PHYCTRL_CTL(1) = (0x3 << SRT_NX4000_DDR_PHY_DLLCTRL_MFSL); // 400MHZ
	PHYCTRL_CTL(6) = MSK_NX4000_DDR_PHY_FIFOINIT_RDPTINITEXE | MSK_NX4000_DDR_PHY_FIFOINIT_WRPTINITEXE;
	PHYCTRL_CTL(2) = (0x1 << SRT_NX4000_DDR_PHY_ZQCALCTRL_ZQCALUPD) | (0x1 << SRT_NX4000_DDR_PHY_ZQCALCTRL_ZQCALFREQ) | (0x7 << SRT_NX4000_DDR_PHY_ZQCALCTRL_ZQCALITVL) |MSK_NX4000_DDR_PHY_ZQCALCTRL_ZQCALMODE | MSK_NX4000_DDR_PHY_ZQCALCTRL_ZQCALSTRV;
	PHYCTRL_CTL(3) = (0x2 << SRT_NX4000_DDR_PHY_ZQODTCTRL_CAPHASE) | MSK_NX4000_DDR_PHY_ZQODTCTRL_WRFIFOEN | (0x1 << SRT_NX4000_DDR_PHY_ZQODTCTRL_FIFORPINIT) | (0x5 << SRT_NX4000_DDR_PHY_ZQODTCTRL_ZQDATA) | (0x5 << SRT_NX4000_DDR_PHY_ZQODTCTRL_ZQCK) | (0x5 << SRT_NX4000_DDR_PHY_ZQODTCTRL_ZQCMDAD) | (0x2 << SRT_NX4000_DDR_PHY_ZQODTCTRL_PHYODT) | MSK_NX4000_DDR_PHY_ZQODTCTRL_PHYODTEN | (0x1 << SRT_NX4000_DDR_PHY_ZQODTCTRL_DRAMIF);
	PHYCTRL_CTL(2) = (0x1 << SRT_NX4000_DDR_PHY_ZQCALCTRL_ZQCALUPD) | (0x1 << SRT_NX4000_DDR_PHY_ZQCALCTRL_ZQCALFREQ) | (0x7 << SRT_NX4000_DDR_PHY_ZQCALCTRL_ZQCALITVL) | MSK_NX4000_DDR_PHY_ZQCALCTRL_ZQCALMODE | MSK_NX4000_DDR_PHY_ZQCALCTRL_ZQCALSTRV | MSK_NX4000_DDR_PHY_ZQCALCTRL_ZQCALRSTB;

	while ((PHYCTRL_CTL(2) & MSK_NX4000_DDR_PHY_ZQCALCTRL_ZQCALEND) != MSK_NX4000_DDR_PHY_ZQCALCTRL_ZQCALEND){};

	PHYCTRL_CTL(4) = (0xe << SRT_NX4000_DDR_PHY_RDCTRL_PHYODTONT) | (0x7 << SRT_NX4000_DDR_PHY_RDCTRL_PHYODTOFT) | (0x4 << SRT_NX4000_DDR_PHY_RDCTRL_PDQODTONT) | (0x7 << SRT_NX4000_DDR_PHY_RDCTRL_PDQODTOFT) | (0xe << SRT_NX4000_DDR_PHY_RDCTRL_PHYBENONT) | (0x7 << SRT_NX4000_DDR_PHY_RDCTRL_PHYBENOFT) | (0x4 << SRT_NX4000_DDR_PHY_RDCTRL_PHYIENONT) | (0x2 << SRT_NX4000_DDR_PHY_RDCTRL_PHYIENOFT);
	PHYCTRL_CTL(5) = MSK_NX4000_DDR_PHY_RDTMG_RDMODE | (0xb << SRT_NX4000_DDR_PHY_RDTMG_RDENVALID) | (0x2 << SRT_NX4000_DDR_PHY_RDTMG_WDOMODE);
	PHYCTRL_CTL(7) = (0x7 << SRT_NX4000_DDR_PHY_OUTCTRL_CKOBUFEN) | (0x2 << SRT_NX4000_DDR_PHY_OUTCTRL_MBL) | (0x6 << SRT_NX4000_DDR_PHY_OUTCTRL_MRL) | (0x7 << SRT_NX4000_DDR_PHY_OUTCTRL_MWL) | MSK_NX4000_DDR_PHY_OUTCTRL_RESETBOE | MSK_NX4000_DDR_PHY_OUTCTRL_CKEODTOE | MSK_NX4000_DDR_PHY_OUTCTRL_ADCMDOE;

	DDRCTRL_DENALI_CTL(00)  = DENALI_CTL_00_DATA | 0x1; // DDR2_START

	while (!(DDRCTRL_DENALI_CTL(158) & 0x800));
	DDRCTRL_DENALI_CTL(159) = 0x800;

	return ecc;
}
